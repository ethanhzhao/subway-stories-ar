<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Card Merge Experience - MindAR</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100vh; }
    video { z-index: -10 !important; }
  </style>

  <script>
  AFRAME.registerComponent('midpoint-handler', {
  init: function () {
    this.target1 = document.querySelector('#personTarget');
    this.target2 = document.querySelector('#stationTarget');
    
    // Vectors for math
    this.p1 = new THREE.Vector3();
    this.p2 = new THREE.Vector3();
    this.mid = new THREE.Vector3();
    
    // Scale vector
    this.s1 = new THREE.Vector3();
  },

  tick: function () {
    // Only run if visible
    if (!this.el.object3D.visible) return;

    // 1. Get Positions
    this.target1.object3D.getWorldPosition(this.p1);
    this.target2.object3D.getWorldPosition(this.p2);

    // 2. Calculate Center
    this.mid.addVectors(this.p1, this.p2).multiplyScalar(0.5);

    // 3. Get Scale from Target 1 (Crucial for MindAR!)
    this.target1.object3D.getWorldScale(this.s1);

    // 4. APPLY TO MERGED MODEL
    this.el.object3D.position.copy(this.mid);
    this.el.object3D.scale.copy(this.s1); // Sync scale with the marker

    // 5. Look at camera (Make sure it faces you)
    this.el.object3D.lookAt(document.querySelector('a-camera').object3D.position);
  }
});
</script>
</head>
<body>
  
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2; autoStart: true; filterMinCF: 0.0001; filterBeta: 0.01; uiLoading: no; uiError: no; uiScanning: no;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    
    <a-entity id="personTarget" mindar-image-target="targetIndex: 0">
      <a-entity id="modelPerson" position="0 0 0">
        <a-box position="0 0 0.1" material="color: #FF3333" scale="0.6 0.6 0.6"></a-box>
        <a-text value="PERSON" position="0 0.6 0.1" align="center" scale="0.8 0.8 0.8"></a-text>
      </a-entity>
    </a-entity>
    
    <a-entity id="stationTarget" mindar-image-target="targetIndex: 1">
      <a-entity id="modelStation" position="0 0 0">
        <a-sphere position="0 0 0.1" material="color: #3333FF" radius="0.4"></a-sphere>
        <a-text value="STATION" position="0 0.6 0.1" align="center" scale="0.8 0.8 0.8"></a-text>
      </a-entity>
    </a-entity>

    <a-entity id="mergedModel" midpoint-handler visible="false">
      <a-box 
        position="0 0 0" 
        material="color: #FF3333; opacity: 0.5; side: double" 
        scale="0.6 0.6 0.6">
      </a-box>

      <a-sphere 
        position="0 0 0" 
        material="color: #3333FF; opacity: 0.9; side: double" 
        radius="0.3"
        scale="1.2 1.2 1.2">
      </a-sphere>

      <a-text 
        value="MERGED!" 
        position="0 0.8 0" 
        align="center" 
        color="#FFD700" 
        scale="0.6 0.6 0.6">
      </a-text>
    </a-entity>
    
  </a-scene>

  <div style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.5); color: white; padding: 15px; border-radius: 10px; font-family: sans-serif; pointer-events: none;">
    <h3 style="margin:0">Merged Logic</h3>
    <p id="status">Scanning...</p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const personTarget = document.querySelector('#personTarget');
      const stationTarget = document.querySelector('#stationTarget');
      const modelPerson = document.querySelector('#modelPerson');
      const modelStation = document.querySelector('#modelStation');
      const mergedModel = document.querySelector('#mergedModel'); // Now outside
      const statusEl = document.querySelector('#status');

      let personVisible = false;
      let stationVisible = false;

      function updateGameLogic() {
        if (personVisible && stationVisible) {
          // MERGED STATE
          modelPerson.setAttribute('visible', false);
          modelStation.setAttribute('visible', false);
          
          // Show the merged model (The 'midpoint-handler' will now take over positioning)
          mergedModel.setAttribute('visible', true);
          statusEl.textContent = "MERGED! (Center)";
          statusEl.style.color = "#FFD700";
        } else {
            
          // SEPARATE STATE
          mergedModel.setAttribute('visible', false);

          if (personVisible) modelPerson.setAttribute('visible', true);
          if (stationVisible) modelStation.setAttribute('visible', true);

          statusEl.textContent = personVisible || stationVisible ? "Found one..." : "Scanning...";
          statusEl.style.color = "#FFF";
        }
      }

      // Event Listeners
      personTarget.addEventListener('targetFound', () => { personVisible = true; updateGameLogic(); });
      personTarget.addEventListener('targetLost', () => { personVisible = false; updateGameLogic(); });
      stationTarget.addEventListener('targetFound', () => { stationVisible = true; updateGameLogic(); });
      stationTarget.addEventListener('targetLost', () => { stationVisible = false; updateGameLogic(); });
    });
  </script>
</body>
</html>