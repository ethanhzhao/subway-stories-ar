<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Card Merge Experience</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; sourceWidth: 1280; sourceHeight: 960; displayWidth: 1280; displayHeight: 960;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    loading-screen="enabled: false">
    
    <!-- Camera -->
    <a-entity camera></a-entity>
    
    <!-- Card A - Person Marker (NFT) - 2.25 x 3.75 inches -->
    <a-nft
      type="nft"
      url="./sampleperson_drawn_web"
      smooth="true"
      smoothCount="20"
      smoothTolerance=".01"
      smoothThreshold="10"
      id="markerPerson"
      markerheight="3.75"
      markerwidth="2.25">
      <a-entity id="modelPerson" position="0 0 0" rotation="0 0 0">
        <!-- Placeholder 3D Model - Person (Red Cube) - VERY LARGE for NFT -->
        <a-box 
          position="0 -100 0" 
          material="color: #FF3333; opacity: 1; side: double;" 
          scale="500 500 500"
          visible="true"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-box>
        <!-- <a-sphere
          position="500 0 0"
          material="color: #00FF00;"
          radius="500"
          visible="true">
        </a-sphere> -->
        <a-text value="PERSON" position="0 1500 0" align="center" color="#FFFFFF" scale="500 500 500"></a-text>
      </a-entity>
    </a-nft>
    
    <!-- Card B - Station Marker (NFT) - 2 x 3.5 inches -->
    <a-nft
      type="nft"
      url="./test_illustration_smaller"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
      id="markerStation"
      markerheight="3.5"
      markerwidth="2">
      <a-entity id="modelStation" position="0 0 0" rotation="0 0 0">
        <!-- Placeholder 3D Model - Station (Blue Sphere) -->
        <a-sphere 
          position="0 50 0" 
          material="color: #3333FF; opacity: 1;" 
          radius="60" 
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-sphere>
        <a-text value="STATION" position="0 200 0" align="center" color="#FFFFFF" scale="50 50 50"></a-text>
      </a-entity>
    </a-nft>
    
    <!-- Merged Model (hidden by default) -->
    <a-entity id="mergedModel" visible="false" position="0 0 0">
      <!-- Placeholder Merged Model - Purple Cylinder with particles effect -->
      <a-cylinder 
        position="0 50 0" 
        material="color: #AA33FF; opacity: 0.8;" 
        radius="80" 
        height="150" 
        animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
      </a-cylinder>
      <a-torus 
        position="0 50 0" 
        material="color: #FFAA33;" 
        radius="100" 
        radius-tubular="10"
        animation="property: rotation; to: 360 0 0; loop: true; dur: 3000">
      </a-torus>
      <a-text 
        value="MERGED!" 
        position="0 200 0" 
        align="center" 
        color="#FFD700" 
        scale="70 70 70"
        animation="property: position; to: 0 220 0; dir: alternate; loop: true; dur: 1000; easing: easeInOutQuad">
      </a-text>
    </a-entity>
    
  </a-scene>

  <script>
    // Track marker visibility
    let markerPersonVisible = false;
    let markerStationVisible = false;
    let isMerged = false;
    let cameraReady = false;
    
    const markerPerson = document.querySelector('#markerPerson');
    const markerStation = document.querySelector('#markerStation');
    const modelPerson = document.querySelector('#modelPerson');
    const modelStation = document.querySelector('#modelStation');
    const mergedModel = document.querySelector('#mergedModel');
    const scene = document.querySelector('a-scene');
    const errorEl = document.querySelector('#error');
    
    // Check if camera is ready
    scene.addEventListener('camera-init', (data) => {
      console.log('Camera initialized');
      cameraReady = true;
      errorEl.textContent = '';
    });
    
    scene.addEventListener('camera-error', (error) => {
      console.error('Camera error:', error);
      errorEl.textContent = 'Camera error! Please grant camera permissions and use HTTPS.';
    });
    
    // Detect when AR.js is ready
    window.addEventListener('arjs-video-loaded', () => {
      console.log('AR.js video loaded');
      cameraReady = true;
    });
    
    // Store marker positions
    let personPos = { x: 0, y: 0, z: 0 };
    let stationPos = { x: 0, y: 0, z: 0 };
    
    // Listen for marker found/lost events
    markerPerson.addEventListener('markerFound', () => {
      console.log('Person marker found');
      console.log('Model Person visibility:', modelPerson.getAttribute('visible'));
      console.log('Model Person position:', modelPerson.object3D.position);
      console.log('Model Person scale:', modelPerson.object3D.scale);
      markerPersonVisible = true;
      checkMerge();
    });
    
    markerPerson.addEventListener('markerLost', () => {
      console.log('Person marker lost');
      markerPersonVisible = false;
      checkMerge();
    });
    
    markerStation.addEventListener('markerFound', () => {
      console.log('Station marker found');
      markerStationVisible = true;
      checkMerge();
    });
    
    markerStation.addEventListener('markerLost', () => {
      console.log('Station marker lost');
      markerStationVisible = false;
      checkMerge();
    });
    
    function checkMerge() {
      // If both markers are visible, merge the models
      if (markerPersonVisible && markerStationVisible && !isMerged) {
        console.log('Merging models!');
        isMerged = true;
        
        // Hide individual models
        modelPerson.setAttribute('visible', 'false');
        modelStation.setAttribute('visible', 'false');
        
        // Calculate midpoint between the two markers
        updateMergedPosition();
        
        // Show merged model
        mergedModel.setAttribute('visible', 'true');
        
        // Add scaling animation for dramatic effect
        mergedModel.setAttribute('animation__scale', {
          property: 'scale',
          from: '0.1 0.1 0.1',
          to: '1 1 1',
          dur: 1000,
          easing: 'easeOutElastic'
        });
      }
      
      // If either marker is lost, unmerge
      if ((!markerPersonVisible || !markerStationVisible) && isMerged) {
        console.log('Unmerging models');
        isMerged = false;
        
        // Show individual models again
        if (markerPersonVisible) modelPerson.setAttribute('visible', 'true');
        if (markerStationVisible) modelStation.setAttribute('visible', 'true');
        
        // Hide merged model
        mergedModel.setAttribute('visible', 'false');
      }
    }
    
    function updateMergedPosition() {
      if (markerPerson.object3D && markerStation.object3D) {
        personPos = markerPerson.object3D.position;
        stationPos = markerStation.object3D.position;
        
        const midpoint = {
          x: (personPos.x + stationPos.x) / 2,
          y: (personPos.y + stationPos.y) / 2 + 0.5,
          z: (personPos.z + stationPos.z) / 2
        };
        
        mergedModel.object3D.position.set(midpoint.x, midpoint.y, midpoint.z);
      }
    }
    
    // Update merged model position continuously when both markers are visible
    setInterval(() => {
      if (isMerged && markerPersonVisible && markerStationVisible) {
        updateMergedPosition();
      }
    }, 100);
  </script>
  
  <!-- Instructions overlay -->
  <div style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 8px; font-family: Arial; max-width: 320px; z-index: 1000;">
    <h3 style="margin: 0 0 10px 0;">ðŸ“± AR Card Experience</h3>
    <p style="margin: 5px 0; font-size: 14px;">âœ“ Using custom rectangular cards</p>
    <p style="margin: 5px 0; font-size: 14px;">1. Point camera at Person card</p>
    <p style="margin: 5px 0; font-size: 14px;">2. Point at Station card</p>
    <p style="margin: 5px 0; font-size: 14px;">3. Show both cards together to merge!</p>
    <hr style="border: 1px solid #666; margin: 10px 0;">
    <p style="margin: 5px 0; font-size: 11px;"><strong>Status:</strong> <span id="status">Initializing camera...</span></p>
    <p style="margin: 5px 0; font-size: 10px; color: #FF6666;" id="error"></p>
  </div>

  <script>
    // Update status display
    function updateStatus() {
      const statusEl = document.querySelector('#status');
      if (!cameraReady) {
        statusEl.textContent = 'Starting camera...';
        statusEl.style.color = '#FFAA00';
      } else if (isMerged) {
        statusEl.textContent = 'âœ¨ MERGED! âœ¨';
        statusEl.style.color = '#FFD700';
      } else if (markerPersonVisible && markerStationVisible) {
        statusEl.textContent = 'Both detected - merging...';
        statusEl.style.color = '#90EE90';
      } else if (markerPersonVisible) {
        statusEl.textContent = 'Person detected âœ“';
        statusEl.style.color = '#FF6666';
      } else if (markerStationVisible) {
        statusEl.textContent = 'Station detected âœ“';
        statusEl.style.color = '#6666FF';
      } else {
        statusEl.textContent = 'Camera ready - show cards';
        statusEl.style.color = '#FFFFFF';
      }
    }
    
    setInterval(updateStatus, 200);
  </script>

</body>
</html>