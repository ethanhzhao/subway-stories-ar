<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MTA AR Experience</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100vh; }
    video { z-index: -10 !important; }
    /* instructions */
    #ui-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.25);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      width: 300px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      /* TRANSITION SETTINGS */
      transition: transform 0.3s ease-in-out;
      transform: translateX(0); /* Default state: Visible */
    }

    /* The Hidden State (Moves panel off-screen to the left) */
    #ui-panel.closed {
      transform: translateX(-100%); /* Move 110% to the left to hide completely */
    }

    /* The Toggle Button */
    #ui-toggle-btn {
      position: absolute;
      top: 0;
      right: -40px; /* Hangs off the right side of the panel */
      width: 35px;
      height: 35px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 5px 5px 5px 5px; /* Rounded corners on right only */
      cursor: pointer;
      backdrop-filter: blur(10px);
      font-weight: bold;
      font-size: 14px;
      outline: none;
    }
  </style>

  <script>
  AFRAME.registerComponent('midpoint-handler', {
    init: function () {
      this.target1 = document.querySelector('#personTarget');
      this.target2 = document.querySelector('#stationTarget');
      
      // Vectors for math (Position & Scale)
      this.p1 = new THREE.Vector3();
      this.p2 = new THREE.Vector3();
      this.mid = new THREE.Vector3();
      this.s1 = new THREE.Vector3();

      // Quaternions for math (Rotation)
      this.q1 = new THREE.Quaternion();
      this.q2 = new THREE.Quaternion();
    },

    tock: function () {
      if (!this.el.object3D.visible) return;

      // 1. FORCE UPDATE
      this.target1.object3D.updateMatrixWorld();
      this.target2.object3D.updateMatrixWorld();

      // 2. GET POSITIONS
      this.target1.object3D.getWorldPosition(this.p1);
      this.target2.object3D.getWorldPosition(this.p2);

      // 3. CALCULATE MIDPOINT
      this.mid.addVectors(this.p1, this.p2).multiplyScalar(0.5);

      // 4. SYNC SCALE
      this.target1.object3D.getWorldScale(this.s1);
      this.el.object3D.scale.copy(this.s1);

      // 5. APPLY POSITION
      this.el.object3D.position.copy(this.mid);

      // 6. ROTATION FIX (Average the two cards)
      // Get rotation of Card 1
      this.target1.object3D.getWorldQuaternion(this.q1);
      // Get rotation of Card 2
      this.target2.object3D.getWorldQuaternion(this.q2);
      
      // "Slerp" (Spherical Blend) them 50% to find the exact middle angle
      this.el.object3D.quaternion.slerpQuaternions(this.q1, this.q2, 0.5);
    }
  });
</script>
</head>
<body>
  
  <a-scene 
    mindar-image="
      imageTargetSrc: ./targets.mind; 
      maxTrack: 2; 
      autoStart: true; 
      filterMinCF: 0.001; 
      filterBeta: 10; 
      uiLoading: no; uiError: no; uiScanning: no;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-assets>
      <a-asset-item id="person-asset" src="./models/default_gltf/rodney3d_default.gltf"></a-asset-item>
      <a-asset-item id="person-waving-asset" src="./models/wave_gtlf/rodney3d_wave.gltf"></a-asset-item>
      <a-asset-item id="station-asset" src="./models/sample_station/scene.gltf"></a-asset-item>
      
      <!-- <a-asset-item id="person-obj" src="./models/person_wave/rodney3d_wave.obj"></a-asset-item>
      <a-asset-item id="person-mtl" src="./models/person_wave/rodney3d_wave.mtl"></a-asset-item> -->
      
      <!-- <a-asset-item id="station-obj" src="./models/sample_station/model.obj"></a-asset-item>
      <a-asset-item id="station-mtl" src="./models/sample_station/model.mtl"></a-asset-item> -->
    </a-assets>

    <!-- <a-light type="directional" position="1 1 1" intensity="2"></a-light>
    <a-light type="ambient" intensity="1"></a-light> -->
    
    <a-entity id="personTarget" mindar-image-target="targetIndex: 0">
      <a-entity id="modelPerson">
        <a-entity 
            gltf-model="#person-asset" 
            scale="0.1 0.1 0.1" 
            rotation="80 0 0" 
            position="0 0 0">
        </a-entity>

        <!-- <a-entity 
            obj-model="obj: #person-obj; mtl: #person-mtl" 
            scale="0.1 0.1 0.1" 
            rotation="80 0 0"
            position="0 0 0">
        </a-entity> -->
      </a-entity>
    </a-entity>
    
    <a-entity id="stationTarget" mindar-image-target="targetIndex: 1">
      <a-entity id="modelStation">
        <a-entity 
            gltf-model="#station-asset" 
            scale="0.1 0.1 0.1" 
            rotation="70 0 0" 
            position="0 0 0">
        </a-entity>
      </a-entity>
    </a-entity>

    <a-entity id="mergedModel" midpoint-handler visible="false">
        
       <a-entity rotation="0 0 0" scale="1.5 1.5 1.5">
          
          <a-entity 
            gltf-model="#station-asset" 
            scale="0.1 0.1 0.1" 
            rotation="70 0 0" 
            position="0 0 0">
          </a-entity>

          <a-entity 
            gltf-model="#person-waving-asset" 
            scale="0.003 0.003 0.003" 
            rotation="70 0 0" 
            position="0.5 0.4 0.1">
          </a-entity>

          <!-- <a-entity 
            obj-model="obj: #person-obj; mtl: #person-mtl" 
            scale="0.003 0.003 0.003"  
            rotation="70 0 0" 
            position="0.5 0.4 0.1">
          </a-entity> -->

       </a-entity>
    </a-entity>
    
  </a-scene>

  <div id="ui-panel">
  <button id="ui-toggle-btn" onclick="toggleUI()">&lt;&lt;</button>
  <h3 style="margin: 0 0 10px 0; font-size: 18px;">Instructions</h3>
  <!-- <p style="margin: 5px 0; font-size: 9px;">{Version: MindAR}</p> -->
  <p style="margin: 5px 0; font-size: 13px;">1. Point camera at person card for person model</p>
  <p style="margin: 5px 0; font-size: 13px;">2. Point at station card for station model</p>
  <p style="margin: 5px 0; font-size: 13px;">3. Show both cards together for interaction</p>
  <hr style="border: 1px solid #666; margin: 10px 0;">
  <p style="margin: 5px 0; font-size: 12px;"><strong>Status:</strong> <span id="status">Scanning...</span></p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const personTarget = document.querySelector('#personTarget');
      const stationTarget = document.querySelector('#stationTarget');
      const modelPerson = document.querySelector('#modelPerson');
      const modelStation = document.querySelector('#modelStation');
      const mergedModel = document.querySelector('#mergedModel'); // Now outside
      const statusEl = document.querySelector('#status');

      let personVisible = false;
      let stationVisible = false;

      function updateGameLogic() {
        if (personVisible && stationVisible) {
          // MERGED STATE
          modelPerson.setAttribute('visible', false);
          modelStation.setAttribute('visible', false);
          
          // Show the merged model (The 'midpoint-handler' determines positioning)
          mergedModel.setAttribute('visible', true);
          statusEl.textContent = "Both cards detected!";
          statusEl.style.color = "#75d15a";
        } else {
            
          // SEPARATE STATE
          mergedModel.setAttribute('visible', false);

          if (personVisible) {
            modelPerson.setAttribute('visible', true);
            statusEl.textContent = "Found person card!"
          }
          if (stationVisible) {
            modelStation.setAttribute('visible', true);
            statusEl.textContent = "Found station card!"
          }

          if (!stationVisible && !personVisible) {
            statusEl.textContent = "Scanning..."
          }

          //statusEl.textContent = personVisible || stationVisible ? "Found one..." : "Scanning...";
          statusEl.style.color = "#FFF";
        }
      }

      // Event Listeners
      personTarget.addEventListener('targetFound', () => { personVisible = true; updateGameLogic(); });
      personTarget.addEventListener('targetLost', () => { personVisible = false; updateGameLogic(); });
      stationTarget.addEventListener('targetFound', () => { stationVisible = true; updateGameLogic(); });
      stationTarget.addEventListener('targetLost', () => { stationVisible = false; updateGameLogic(); });
    });

    function toggleUI() {
  const panel = document.getElementById('ui-panel');
  const btn = document.getElementById('ui-toggle-btn');
  
  // Toggle the class that moves the panel off-screen
  panel.classList.toggle('closed');
  
  // Check if it's closed to change the text
  if (panel.classList.contains('closed')) {
    btn.innerHTML = "&gt;&gt;"; // Shows ">>"
  } else {
    btn.innerHTML = "&lt;&lt;"; // Shows "<<"
  }
}
  </script>
</body>
</html>