<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Card Merge Experience - MindAR</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100vh;
    }
    html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    /* Fix for video background z-index issues */
    video {
        z-index: -10 !important;
    }
  </style>
</head>
<body>
  
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2; autoStart: true; filterMinCF: 0.0001; filterBeta: 0.01; uiLoading: no; uiError: no; uiScanning: no;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    
    <!-- Target 0: Person Card -->
    <a-entity id="personTarget" mindar-image-target="targetIndex: 0">
      
      <!-- STANDARD MODEL: Person (Red Cube) -->
      <a-entity id="modelPerson" position="0 0 0">
        <a-box 
          position="0 0 0.1" 
          material="color: #FF3333; opacity: 1; side: double;" 
          scale="0.6 0.6 0.6"
        </a-box>
        <a-text 
          value="PERSON" 
          position="0 0.6 0.1" 
          align="center" 
          color="#FFFFFF" 
          scale="0.8 0.8 0.8">
        </a-text>
      </a-entity>
      
      <!-- MERGED MODEL (Hidden by default) -->
      <!-- Attached to Person Card but offset slightly to right (0.5) -->
      <a-entity id="mergedModel" visible="false" position="0.5 0 0.1">
        
        <!-- COPY OF PERSON MODEL (Left side) -->
        <a-box 
          position="0 0 0" 
          material="color: #FF3333; opacity: 0.5; side: double;" 
          scale="0.6 0.6 0.6"
          
        </a-box>

        <!-- COPY OF STATION MODEL (Right side) -->
        <a-sphere 
          position="0 0 0" 
          material="color: #3333FF; opacity: 0.9; side: double;" 
          radius="0.3"
          
        </a-sphere>

        <a-text 
          value="MERGED!" 
          position="0 0.8 0" 
          align="center" 
          color="#FFD700" 
          scale="0.6 0.6 0.6"
        </a-text>
      </a-entity>
    </a-entity>
    
    <!-- Target 1: Station Card -->
    <a-entity id="stationTarget" mindar-image-target="targetIndex: 1">
      <!-- STANDARD MODEL: Station (Blue Sphere) -->
      <a-entity id="modelStation" position="0 0 0">
        <a-sphere 
          position="0 0 0.1" 
          material="color: #3333FF; opacity: 1; side: double;" 
          radius="0.4"
        </a-sphere>
        <a-text 
          value="STATION" 
          position="0 0.6 0.1" 
          align="center" 
          color="#FFFFFF" 
          scale="0.8 0.8 0.8">
        </a-text>
      </a-entity>
    </a-entity>
    
  </a-scene>

  <!-- Instructions UI -->
  <div style="position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.25); color: white; padding: 15px; border-radius: 10px; font-family: Arial, sans-serif; max-width: 320px; z-index: 1000; backdrop-filter: blur(10px);">
    <h3 style="margin: 0 0 10px 0; font-size: 18px;">WebAR Cards</h3>
    <p style="margin: 5px 0; font-size: 13px;">{Version: MindAR}</p>
    <p style="margin: 5px 0; font-size: 13px;">1. Point camera at Person card - shows red cube</p>
    <p style="margin: 5px 0; font-size: 13px;">2. Point at Station card - shows blue sphere</p>
    <p style="margin: 5px 0; font-size: 13px;">3. Show both cards together for interaction</p>
    <hr style="border: 1px solid #666; margin: 10px 0;">
    <p style="margin: 5px 0; font-size: 12px;"><strong>Status:</strong> <span id="status">Initializing...</span></p>
    <p style="margin: 5px 0; font-size: 11px;"><span id="debug" style="font-family: monospace; color: #FFD700;">P:NO | S:NO</span></p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      
      // 1. Grab all references once at the start
      const personTarget = document.querySelector('#personTarget');
      const stationTarget = document.querySelector('#stationTarget');
      const modelPerson = document.querySelector('#modelPerson');
      const modelStation = document.querySelector('#modelStation');
      const mergedModel = document.querySelector('#mergedModel');
      
      // UI Elements
      const statusEl = document.querySelector('#status');
      const debugEl = document.querySelector('#debug');

      // 2. State Tracking
      let personVisible = false;
      let stationVisible = false;

      // 3. THE LOGIC: Update everything based on current state
      function updateGameLogic() {
        
        // Update Debug Text
        debugEl.textContent = `P:${personVisible ? 'YES' : 'NO'} | S:${stationVisible ? 'YES' : 'NO'}`;

        // --- SCENARIO: MERGE (Both Visible) ---
        if (personVisible && stationVisible) {
          console.log('State: MERGED');
          
          // Hide individual models
          modelPerson.setAttribute('visible', false);
          modelStation.setAttribute('visible', false);
          
          // Show merged model
          mergedModel.setAttribute('visible', true);
          
          // Update UI
          statusEl.textContent = 'MERGED!';
          statusEl.style.color = '#FFD700'; // Gold
          statusEl.style.fontWeight = 'bold';
        } 
        
        // --- SCENARIO: NOT MERGED (One or None Visible) ---
        else {
          // Always hide merged model if we aren't merging
          mergedModel.setAttribute('visible', false);

          // Determine what to show based on what is visible
          if (personVisible) {
            modelPerson.setAttribute('visible', true); // Show Person
            statusEl.textContent = 'Person detected ✓';
            statusEl.style.color = '#FF6666'; // Reddish
          } else {
            // We don't strictly need to hide modelPerson here because 
            // the parent 'personTarget' hides automatically, but it's good practice for state hygiene
            modelPerson.setAttribute('visible', true); 
          }

          if (stationVisible) {
            modelStation.setAttribute('visible', true); // Show Station
            // Only update text to Station if Person isn't also there (handled by Merge logic)
            if(!personVisible) {
                statusEl.textContent = 'Station detected ✓';
                statusEl.style.color = '#6666FF'; // Blueish
            }
          } else {
            modelStation.setAttribute('visible', true);
          }

          // If neither are visible
          if (!personVisible && !stationVisible) {
            statusEl.textContent = 'Point at cards to begin';
            statusEl.style.color = '#FFFFFF';
          }
        }
      }

      // 4. Event Listeners (No SetTimeout needed!)
      
      personTarget.addEventListener('targetFound', () => {
        personVisible = true;
        updateGameLogic();
      });

      personTarget.addEventListener('targetLost', () => {
        personVisible = false;
        updateGameLogic();
      });

      stationTarget.addEventListener('targetFound', () => {
        stationVisible = true;
        updateGameLogic();
      });

      stationTarget.addEventListener('targetLost', () => {
        stationVisible = false;
        updateGameLogic();
      });

    });
  </script>

</body>
</html>