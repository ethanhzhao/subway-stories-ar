<!-- WORKING OLD HTML -- merge working! with unmerge issue! (sometimes after merge, will not display individual) -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Card Merge Experience - MindAR</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100vh;
    }
    html {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    a-scene {
      display: block;
      position: absolute;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    canvas {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
    }
  </style>
</head>
<body>
  
  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2; autoStart: true; filterMinCF: 0.0001; filterBeta: 0.01; uiLoading: no; uiError: no; uiScanning: no;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">
    
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    
    <!-- Target 0: Person Card -->
    <a-entity id="personTarget" mindar-image-target="targetIndex: 0">
      <a-entity id="modelPerson" position="0 0 0">
        <!-- Placeholder 3D Model - Person (Red Cube) -->
        <a-box 
          position="0 0 0.1" 
          material="color: #FF3333; opacity: 1; side: double;" 
          scale="0.8 0.8 0.8"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"> 
        </a-box>
        <a-text 
          value="PERSON" 
          position="0 0.6 0.1" 
          align="center" 
          color="#FFFFFF" 
          scale="0.8 0.8 0.8">
        </a-text>
      </a-entity>
      
      <!-- Merged model attached to person card -->
      <a-entity id="mergedModel" visible="false" position="0.5 0 0.1">
        <!-- Placeholder Merged Model - Purple Cylinder with torus effect -->
        <a-box 
          position="0 0.3 0" 
          material="color: #FF3333; opacity: 0.9; side: double;" 
          scale="0.6 0.6 0.6"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"> 
        </a-box>
        <a-torus 
          position="0 0.3 0" 
          material="color: #3333FF; opacity: 0.8; side: double;" 
          radius="0.4" 
          radius-tubular="0.05"
          animation="property: rotation; to: 360 0 0; loop: true; dur: 3000"> 
        </a-torus>
        <a-text 
          value="MERGED!" 
          position="0 0.8 0" 
          align="center" 
          color="#FFD700" 
          scale="0.6 0.6 0.6"
          animation="property: position; to: 0 0.9 0; dir: alternate; loop: true; dur: 1000; easing: easeInOutQuad">
        </a-text>
      </a-entity>
    </a-entity>
    
    <!-- Target 1: Station Card -->
    <a-entity id="stationTarget" mindar-image-target="targetIndex: 1">
      <a-entity id="modelStation" position="0 0 0">
        <!-- Placeholder 3D Model - Station (Blue Sphere) -->
        <a-sphere 
          position="0 0 0.1" 
          material="color: #3333FF; opacity: 1; side: double;" 
          radius="0.4"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
        </a-sphere>
        <a-text 
          value="STATION" 
          position="0 0.6 0.1" 
          align="center" 
          color="#FFFFFF" 
          scale="0.8 0.8 0.8">
        </a-text>
      </a-entity>
    </a-entity>
    
  </a-scene>

  <script>
    // Track marker visibility
    let personVisible = false;
    let stationVisible = false;
    let isMerged = false;
    
    let personTarget, stationTarget, modelPerson, modelStation, mergedModel, scene;
    
    console.log('Script starting...');
    
    // Wait for A-Frame scene to be ready
    window.addEventListener('load', () => {
      console.log('Window loaded');
      
      scene = document.querySelector('a-scene');
      console.log('Scene element:', scene);
      
      if (scene.hasLoaded) {
        console.log('Scene already loaded, initializing now');
        init();
      } else {
        scene.addEventListener('loaded', () => {
          console.log('Scene loaded event fired');
          init();
        });
      }
    });
    
    function init() {
      console.log('Initializing...');
      
      personTarget = document.querySelector('#personTarget');
      stationTarget = document.querySelector('#stationTarget');
      modelPerson = document.querySelector('#modelPerson');
      modelStation = document.querySelector('#modelStation');
      mergedModel = document.querySelector('#mergedModel');
      
      console.log('Elements found:', {
        personTarget: !!personTarget,
        stationTarget: !!stationTarget,
        modelPerson: !!modelPerson,
        modelStation: !!modelStation,
        mergedModel: !!mergedModel
      });
      
      if (!personTarget || !stationTarget) {
        console.error('Target elements not found!');
        return;
      }
      
      // Listen for target found/lost events
      personTarget.addEventListener('targetFound', () => {
        console.log('Person card FOUND');
        personVisible = true;
        checkMerge();
      });
      
      personTarget.addEventListener('targetLost', () => {
        console.log('Person card LOST');
        personVisible = false;
        checkMerge();
      });
      
      stationTarget.addEventListener('targetFound', () => {
        console.log('Station card FOUND');
        stationVisible = true;
        checkMerge();
      });
      
      stationTarget.addEventListener('targetLost', () => {
        console.log('Station card LOST');
        stationVisible = false;
        checkMerge();
      });
      
      console.log('âœ… Event listeners attached');
    }
    
    function checkMerge() {
      console.log(`Check merge - Person: ${personVisible}, Station: ${stationVisible}, Merged: ${isMerged}`);
      
      // If both markers are visible, merge the models
      if (personVisible && stationVisible && !isMerged) {
        console.log('MERGING MODELS!');
        isMerged = true;
        
        // Hide individual models
        modelPerson.setAttribute('visible', 'false');
        modelStation.setAttribute('visible', 'false');
        
        // Show merged model
        mergedModel.setAttribute('visible', 'true');
        
        // Add scaling animation for dramatic effect
        mergedModel.setAttribute('animation__scale', {
          property: 'scale',
          from: '0.1 0.1 0.1',
          to: '1.2 1.2 1.2',
          dur: 800,
          easing: 'easeOutElastic'
        });
        
        // Add a pulse effect
        setTimeout(() => {
          mergedModel.setAttribute('animation__pulse', {
            property: 'scale',
            from: '1.2 1.2 1.2',
            to: '1.0 1.0 1.0',
            dur: 400,
            easing: 'easeInOutQuad'
          });
        }, 800);
      }
      
      // If either marker is lost, unmerge
      if ((!personVisible || !stationVisible) && isMerged) {
        console.log('UNMERGING MODELS');
        isMerged = false;
        
        // Hide merged model first
        mergedModel.setAttribute('visible', 'false');
        
        // Use setTimeout to ensure proper state update
        setTimeout(() => {
          console.log(`Restoring models - Person visible: ${personVisible}, Station visible: ${stationVisible}`);
          
          if (personVisible) {
            console.log('Showing person model');
            modelPerson.setAttribute('visible', 'true');
          } else {
            console.log('Person not visible, keeping hidden');
          }
          
          if (stationVisible) {
            console.log('âœ… Showing station model');
            modelStation.setAttribute('visible', 'true');
          } else {
            console.log('Station not visible, keeping hidden');
          }
        }, 100);
      }
    }
    
    // Update status display
    function updateStatus() {
      const statusEl = document.querySelector('#status');
      const debugEl = document.querySelector('#debug');
      if (!statusEl) return;
      
      // Update debug info
      if (debugEl) {
        debugEl.textContent = `P:${personVisible ? 'YES' : 'NO'} | S:${stationVisible ? 'YES' : 'NO'}`;
      }
      
      if (isMerged) {
        statusEl.textContent = 'MERGED!';
        statusEl.style.color = '#FFD700';
        statusEl.style.fontWeight = 'bold';
      } else if (personVisible && stationVisible) {
        statusEl.textContent = 'Both detected - merging...';
        statusEl.style.color = '#90EE90';
        statusEl.style.fontWeight = 'normal';
      } else if (personVisible) {
        statusEl.textContent = 'Person detected âœ“';
        statusEl.style.color = '#FF6666';
        statusEl.style.fontWeight = 'normal';
      } else if (stationVisible) {
        statusEl.textContent = 'Station detected âœ“';
        statusEl.style.color = '#6666FF';
        statusEl.style.fontWeight = 'normal';
      } else {
        statusEl.textContent = 'Point at cards to begin';
        statusEl.style.color = '#FFFFFF';
        statusEl.style.fontWeight = 'normal';
      }
    }
    
    setInterval(updateStatus, 100);
    
    // Log when scene is ready
    window.addEventListener('load', () => {
      console.log('Checking for renderstart event');
      const sceneEl = document.querySelector('a-scene');
      if (sceneEl) {
        sceneEl.addEventListener('renderstart', () => {
          console.log('âœ… MindAR scene ready and rendering');
        });
      }
    });
  </script>
  
  
  <!-- Instructions overlay -->
  <div style="position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.25); color: white; padding: 15px; border-radius: 10px; font-family: Arial, sans-serif; max-width: 320px; z-index: 1000; backdrop-filter: blur(10px);">
    <h3 style="margin: 0 0 10px 0; font-size: 18px;">ðŸ“± AR Card Experience</h3>
    <p style="margin: 5px 0; font-size: 13px;">MindAR Test</p>
    <p style="margin: 5px 0; font-size: 13px;">1. Point camera at Person card (Shows red cube)</p>
    <p style="margin: 5px 0; font-size: 13px;">2. Point at Station card (Shows blue sphere)</p>
    <p style="margin: 5px 0; font-size: 13px;">3. Show both cards together to merge!</p>
    <hr style="border: 1px solid #666; margin: 10px 0;">
    <p style="margin: 5px 0; font-size: 12px;"><strong>Status:</strong> <span id="status">Initializing...</span></p>
    <p style="margin: 5px 0; font-size: 11px;"><span id="debug" style="font-family: monospace; color: #FFD700;">P:NO | S:NO</span></p>
  </div>

</body>
</html>